<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Number Match Infinity</title>
    <style>
        :root {
            --bg: #0f172a;
            --grid-panel: #1e293b;
            --accent: #10b981;
            /* Couleurs blocs */
            --c1: #ff4d4d; --c2: #2ecc71; --c3: #f1c40f; 
            --c4: #9b59b6; --c5: #e67e22; --c6: #1abc9c; 
            --c7: #e84393; --c8: #3498db; --c9: #a29bfe;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: sans-serif; background: var(--bg); color: #fff; overflow: hidden; }

        /* --- UI & ANIMATIONS --- */
        #home-screen {
            position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(rgba(15,23,42,0.8), rgba(15,23,42,0.8)), url('NumberMatchInfinity.png'), var(--bg);
            background-size: cover; background-position: center; transition: transform 0.5s ease-in-out;
        }

        .menu-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); text-align: center; width: 90%; max-width: 400px; }
        .btn-menu { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 15px; font-size: 1.2rem; font-weight: bold; color: white; cursor: pointer; }
        .btn-new { background: #6366f1; }
        .btn-resume { background: rgba(255,255,255,0.1); border: 1px solid #fff; }

        #game-ui { display: flex; flex-direction: column; height: 100vh; visibility: hidden; opacity: 0; transition: 0.5s; }
        .header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); height: 60px; }
        
        #grid-container { flex: 1; overflow-y: auto; padding: 15px 10px 140px; display: flex; justify-content: center; align-items: flex-start; }
        #grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px; width: 100%; max-width: 450px; }

        .cell {
            aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: clamp(1rem, 4vw, 1.5rem); font-weight: 900; background: rgba(255,255,255,0.05);
            transition: all 0.2s ease; position: relative;
        }
        .cell.active { background: var(--grid-panel); border: 1px solid rgba(255,255,255,0.1); }
        .cell.selected { background: #fff !important; color: #000 !important; transform: scale(1.1); z-index: 10; box-shadow: 0 0 15px #fff; }
        .cell.hint { animation: flash 0.6s infinite alternate; border: 2px solid #fff; }
        .cell.obstacle { background: #475569; color: #cbd5e1; }

        @keyframes flash { from { opacity: 0.4; } to { opacity: 1; } }
        @keyframes shake { 0%, 100% { transform:translate(0,0); } 25% { transform:translate(-4px, 4px); } 50% { transform:translate(4px, -4px); } 75% { transform:translate(-4px, -4px); } }
        .shake { animation: shake 0.3s ease-in-out; }

        #toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 12px 25px; border-radius: 20px; font-weight: 900; z-index: 3000; opacity: 0; transition: 0.3s; pointer-events: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

        .toolbar { position: fixed; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; padding: 15px; background: rgba(15,23,42,0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); }
        .btn-tool { flex: 1; max-width: 100px; padding: 12px 5px; border: none; border-radius: 12px; font-weight: bold; font-size: 0.8rem; color: white; background: #4f46e5; }
        .particle { position: absolute; pointer-events: none; border-radius: 50%; z-index: 2000; }

        /* Couleurs chiffres */
        .v1 { color: var(--c1); background: rgba(255,77,77,0.1) !important; }
        .v2 { color: var(--c2); background: rgba(46,204,113,0.1) !important; }
        .v3 { color: var(--c3); background: rgba(241,196,15,0.1) !important; }
        .v4 { color: var(--c4); background: rgba(155,89,182,0.1) !important; }
        .v5 { color: var(--c5); background: rgba(230,126,34,0.1) !important; }
        .v6 { color: var(--c6); background: rgba(26,188,156,0.1) !important; }
        .v7 { color: var(--c7); background: rgba(232,67,147,0.1) !important; }
        .v8 { color: var(--c8); background: rgba(52,152,219,0.1) !important; }
        .v9 { color: var(--c9); background: rgba(162,155,254,0.1) !important; }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="menu-card">
            <h1>NUMBER MATCH<br><span style="color:var(--accent)">INFINITY</span></h1>
            <button id="res-btn" class="btn-menu btn-resume" style="display:none" onclick="launch(true)">REPRENDRE</button>
            <button class="btn-menu btn-new" onclick="launch(false)">NOUVEAU JEU</button>
        </div>
    </div>

    <div id="game-ui">
        <div class="header">
            <div>LVL <span id="lvl" style="color:var(--c3)">1</span></div>
            <button onclick="location.reload()" style="background:none; border:1px solid #555; color:white; border-radius:8px; padding:5px 10px;">MENU</button>
            <div>SCORE <span id="scr" style="color:var(--c3)">0</span></div>
        </div>
        <div id="grid-container"><div id="grid"></div></div>
        <div id="toast">BIEN JOUÃ‰ !</div>
        <div class="toolbar">
            <button class="btn-tool" onclick="addRows()">âž• LIGNES</button>
            <button class="btn-tool" onclick="getHint()">ðŸ’¡ AIDE</button>
            <button class="btn-tool" style="background:#ef4444" onclick="bomb()">ðŸ’£ BOMBE</button>
        </div>
    </div>

    <script>
        let state = { nums: [], score: 0, level: 1, selected: null, hints: [] };
        let audioCtx;
        let lineCounter = 0;
        let baseBombCost = 100;
        const messages = ["BIEN JOUÃ‰ !", "INCROYABLE !", "GÃ‰NIAL !", "QUEL TALENT !", "MAGNIFIQUE !", "BOUUUM !"];

        // --- MOTEUR AUDIO ---
        function playSfx(f, t='sine', d=0.1, v=0.1) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function sfxExplosion() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const d = 0.5;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = 'sawtooth';
            o.frequency.setValueAtTime(150, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + d);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function sfxVictory() {
            const notes = [523.25, 523.25, 523.25, 698.46]; 
            notes.forEach((f, i) => {
                setTimeout(() => playSfx(f, 'sawtooth', 0.3, 0.1), i * 150);
            });
        }

        function sfxMatch() {
            playSfx(440, 'sine', 0.1, 0.1);
            setTimeout(() => playSfx(880, 'sine', 0.1, 0.08), 50);
        }

        function sfxSlide() {
            playSfx(1200, 'sine', 0.3, 0.05);
        }

        // --- LOGIQUE UI ---
        function showToast(customMsg) {
            const t = document.getElementById('toast');
            const msgIndex = Math.floor(Math.random()*messages.length);
            t.innerText = customMsg || messages[msgIndex];
            t.style.opacity = "1";
            
            playSfx(440 + (msgIndex * 100), 'triangle', 0.2, 0.1);
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            setTimeout(() => t.style.opacity = "0", 1500);
        }

        function launch(resume) {
            if(resume) {
                const data = localStorage.getItem('NM_Master_Save');
                if(data) state = JSON.parse(data);
            } else {
                state.level = 1; state.score = 0; newLevel();
            }
            document.getElementById('home-screen').style.transform = 'translateY(-100%)';
            document.getElementById('game-ui').style.cssText = "visibility:visible; opacity:1;";
            render();
        }

        function newLevel() {
            state.nums = Array.from({length: 27}, () => Math.floor(Math.random()*9)+1);
            if(state.level % 10 === 0) {
                for(let i=0; i<3; i++) state.nums[Math.floor(Math.random()*27)] = "ðŸ”’";
            }
            state.selected = null; state.hints = [];
        }

        function render() {
            for (let i = 0; i <= state.nums.length - 9; i += 9) {
                let chunk = state.nums.slice(i, i + 9);
                if (chunk.length === 9 && chunk.every(n => n === null)) {
                    state.nums.splice(i, 9);
                    lineCounter++;
                    sfxSlide();
                    if(lineCounter % 6 === 0) showToast();
                    i -= 9;
                }
            }

            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            state.nums.forEach((n, i) => {
                const cell = document.createElement('div');
                const isNum = typeof n === 'number';
                cell.className = `cell ${isNum ? 'active v'+n : ''} ${n === "ðŸ”’" ? 'obstacle' : ''}`;
                if(i === state.selected) cell.classList.add('selected');
                if(state.hints.includes(i)) cell.classList.add('hint');
                cell.textContent = n || '';
                cell.onclick = (e) => handleTap(i, e);
                grid.appendChild(cell);
            });

            document.getElementById('scr').innerText = state.score;
            document.getElementById('lvl').innerText = state.level;
            
            const hasNumbersLeft = state.nums.some(n => typeof n === 'number');

            if (!hasNumbersLeft && state.nums.length > 0) {
                setTimeout(() => {
                    state.level++;
                    showToast("NIVEAU " + state.level + " ! ðŸš€");
                    sfxVictory();
                    newLevel();
                    render();
                }, 600);
            }

            const currentBombCost = baseBombCost + (Math.floor(state.level / 5) * 50);
            document.querySelector('button[style*="#ef4444"]').innerText = "ðŸ’£ " + currentBombCost;

            localStorage.setItem('NM_Master_Save', JSON.stringify(state));
        }

        function handleTap(i, e) {
            if(typeof state.nums[i] !== 'number') return;
            state.hints = [];
            if(state.selected === null) {
                state.selected = i; playSfx(440);
            } else if(state.selected === i) {
                state.selected = null;
            } else {
                if(checkMatch(state.selected, i)) {
                    spawnFx(e.clientX, e.clientY, state.nums[i]);
                    state.nums[state.selected] = null; state.nums[i] = null;
                    state.score += 10; state.selected = null;
                    sfxMatch();
                } else {
                    state.selected = i; playSfx(220);
                }
            }
            render();
        }

        function checkMatch(i1, i2) {
            const v1 = state.nums[i1], v2 = state.nums[i2];
            if(v1 !== v2 && v1+v2 !== 10) return false;
            const x1 = i1%9, y1 = Math.floor(i1/9), x2 = i2%9, y2 = Math.floor(i2/9);
            const start = Math.min(i1, i2), end = Math.max(i1, i2);

            let blockedL = false;
            for(let k=start+1; k<end; k++) if(state.nums[k] !== null) { blockedL=true; break; }
            if(!blockedL) return true;

            if(x1 === x2) {
                let blockedV = false;
                for(let k=start+9; k<end; k+=9) if(state.nums[k] !== null) { blockedV=true; break; }
                if(!blockedV) return true;
            }

            if(Math.abs(x1-x2) === Math.abs(y1-y2)) {
                const sx = x2>x1?1:-1, sy = y2>y1?1:-1;
                let cx = x1+sx, cy = y1+sy;
                while(cx !== x2) {
                    if(state.nums[cy*9+cx] !== null) return false;
                    cx += sx; cy += sy;
                }
                return true;
            }
            return false;
        }

        function spawnFx(x, y, n) {
            const color = getComputedStyle(document.documentElement).getPropertyValue('--c'+n);
            for(let i=0; i<10; i++) {
                const p = document.createElement('div');
                p.className = 'particle'; p.style.background = color;
                p.style.left = x+'px'; p.style.top = y+'px';
                const s = Math.random()*6+4; p.style.width = p.style.height = s+'px';
                document.body.appendChild(p);
                const a = Math.random()*Math.PI*2, d = Math.random()*60+20;
                p.animate([{opacity:1}, {transform:`translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px) scale(0)`, opacity:0}], 600).onfinish = () => p.remove();
            }
        }

        function getHint() {
            for(let i=0; i<state.nums.length; i++) {
                if(typeof state.nums[i] !== 'number') continue;
                for(let j=i+1; j<state.nums.length; j++) {
                    if(typeof state.nums[j] === 'number' && checkMatch(i, j)) {
                        state.hints = [i, j]; render(); return;
                    }
                }
            }
        }

        function addRows() {
            const active = state.nums.filter(n => typeof n === 'number');
            state.nums = [...state.nums, ...active];
            playSfx(300, 'sawtooth'); render();
        }

        function bomb() {
            const currentBombCost = baseBombCost + (Math.floor(state.level / 5) * 50);
            if (state.score < currentBombCost) {
                showToast("PAS ASSEZ DE POINTS !");
                playSfx(150, 'sawtooth', 0.2);
                return;
            }
            state.score -= currentBombCost;
            if (navigator.vibrate) navigator.vibrate(200);
            document.getElementById('game-ui').classList.add('shake');
            setTimeout(() => document.getElementById('game-ui').classList.remove('shake'), 300);
            
            let t = state.nums.map((n, i) => typeof n === 'number' ? i : null).filter(n => n !== null);
            for(let i=0; i<Math.min(5, t.length); i++) {
                let r = Math.floor(Math.random()*t.length);
                state.nums[t[r]] = null; t.splice(r, 1);
            }
            sfxExplosion();
            showToast("-" + currentBombCost + " POINTS ðŸ’£");
            render();
        }

        if(localStorage.getItem('NM_Master_Save')) document.getElementById('res-btn').style.display = 'block';
    </script>
</body>
</html>